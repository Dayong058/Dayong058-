<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>å‘å¸ƒé—²ç½® | äºŒæ‰‹å¸‚åœº</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg1: #fff1e6;
      --bg2: #ffe6f3;
      --bg3: #fff8d6;
      --bg4: #e8fff6;
      --card: rgba(255, 255, 255, .82);
      --line: rgba(17, 24, 39, .10);
      --text: #121826;
      --muted: rgba(18, 24, 38, .62);
      --primary: #ff6b6b;
      --primary2: #ff8e53;
      --teal: #4ecdc4;
      --green: #06d6a0;
      --shadow: 0 18px 48px rgba(17, 24, 39, .14);
      --r: 18px;
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
      --ease: cubic-bezier(.2, .8, .2, 1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 700px at 10% 0%, rgba(255, 107, 107, .20), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(255, 142, 83, .18), transparent 55%),
        radial-gradient(900px 700px at 20% 95%, rgba(6, 214, 160, .14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2) 35%, var(--bg3) 70%, var(--bg4));
      background-attachment: fixed;
      padding: calc(14px + var(--safeT)) 14px calc(18px + var(--safeB)) 14px;
    }

    .topbar {
      position: sticky;
      top: calc(8px + var(--safeT));
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px;
      border-radius: 20px;
      background: rgba(255, 255, 255, .78);
      border: 1px solid rgba(17, 24, 39, .10);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, rgba(255, 107, 107, .25), rgba(255, 142, 83, .22));
      border: 1px solid rgba(17, 24, 39, .10);
    }

    .title {
      font-weight: 900;
      letter-spacing: .2px;
    }

    .sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .btn {
      border: none;
      cursor: pointer;
      border-radius: 16px;
      padding: 10px 14px;
      font-weight: 900;
      transition: transform 140ms var(--ease), filter 140ms var(--ease), box-shadow 140ms var(--ease);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:active {
      transform: translateY(1px) scale(.985);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color: #1a1020;
      box-shadow: 0 18px 34px rgba(255, 107, 107, .22);
    }

    .btn-ghost {
      background: rgba(18, 24, 38, .06);
      color: rgba(18, 24, 38, .85);
      border: 1px solid rgba(17, 24, 39, .10);
      box-shadow: 0 10px 22px rgba(17, 24, 39, .06);
    }

    .wrap {
      width: min(900px, 100%);
      margin: 14px auto 0;
    }

    .card {
      background: var(--card);
      border: 1px solid rgba(17, 24, 39, .10);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: -2px;
      background:
        radial-gradient(280px 200px at 10% 0%, rgba(255, 107, 107, .18), transparent 60%),
        radial-gradient(280px 200px at 100% 10%, rgba(255, 142, 83, .16), transparent 60%),
        radial-gradient(320px 260px at 80% 120%, rgba(6, 214, 160, .14), transparent 55%);
      opacity: .0;
      filter: blur(10px);
      transition: opacity 220ms var(--ease);
      pointer-events: none;
    }

    .card:hover::after {
      opacity: 1;
    }

    .cardHead {
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(17, 24, 39, .08);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 107, 107, .14);
      border: 1px solid rgba(255, 107, 107, .22);
      font-size: 12px;
      font-weight: 900;
    }

    .cardBody {
      padding: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 720px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 900;
      color: rgba(18, 24, 38, .70);
      margin: 0 0 6px 2px;
    }

    .input,
    .select,
    .textarea {
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(17, 24, 39, .10);
      background: rgba(255, 255, 255, .92);
      padding: 12px 12px;
      outline: none;
      color: var(--text);
      transition: box-shadow 220ms var(--ease), border-color 220ms var(--ease);
    }

    .textarea {
      min-height: 110px;
      resize: vertical;
    }

    .input:focus,
    .select:focus,
    .textarea:focus {
      border-color: rgba(255, 107, 107, .35);
      box-shadow: 0 0 0 6px rgba(255, 107, 107, .16);
    }

    .hint {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .uploader {
      display: grid;
      gap: 10px;
      margin-top: 4px;
    }

    .preview {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }

    @media (max-width: 560px) {
      .preview {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .thumb {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 14px;
      border: 1px solid rgba(17, 24, 39, .10);
      overflow: hidden;
      background: rgba(255, 255, 255, .75);
      box-shadow: 0 10px 22px rgba(17, 24, 39, .08);
      position: relative;
      transform: translateY(0);
      transition: transform 220ms var(--ease), box-shadow 220ms var(--ease);
    }

    .thumb:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 30px rgba(17, 24, 39, .12);
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .actions {
      display: flex;
      gap: 10px;
      padding: 14px;
      border-top: 1px solid rgba(17, 24, 39, .08);
      background: rgba(255, 255, 255, .66);
    }

    .actions .btn {
      flex: 1;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: calc(16px + var(--safeB));
      transform: translateX(-50%);
      background: rgba(18, 24, 38, .88);
      color: rgba(255, 255, 255, .95);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, .22);
      opacity: 0;
      pointer-events: none;
      transition: opacity 220ms var(--ease), transform 220ms var(--ease);
      z-index: 99;
      max-width: min(520px, calc(100% - 24px));
      text-align: center;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">ğŸ’°</div>
      <div>
        <div class="title">å‘å¸ƒé—²ç½®ï¼ˆå‡ºå”®ï¼‰</div>
        <div class="sub">å­—æ®µ/æ¥å£ä¸åç«¯å®Œå…¨ä¸€è‡´ï¼Œç›´æ¥ä¸Šçº¿å¯è·‘</div>
      </div>
    </div>
    <button class="btn btn-ghost" id="backBtn">è¿”å›</button>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="cardHead">
        <div>
          <div class="badge">ğŸ“Œ æˆ‘è¦å‡ºæ‰‹</div>
          <div class="hint">å¿…å¡«ï¼šæ ‡é¢˜ / ä»·æ ¼ / åˆ†ç±» / ä½ç½® / æè¿°</div>
        </div>
        <div class="hint" id="tgInfo"></div>
      </div>

      <form id="sellForm">
        <div class="cardBody">
          <div class="grid">
            <div>
              <label>å•†å“æ ‡é¢˜ *</label>
              <input class="input" name="title" maxlength="50" placeholder="ä¾‹å¦‚ï¼šiPhone 13 128G" required />
            </div>
            <div>
              <label>ä»·æ ¼(å…ƒ) *</label>
              <input class="input" name="price" type="number" step="0.01" placeholder="ä¾‹å¦‚ï¼š1999" required />
            </div>

            <div>
              <label>åˆ†ç±» *</label>
              <select class="select" name="category" id="categorySel" required>
                <option value="">åŠ è½½ä¸­...</option>
              </select>
            </div>

            <div>
              <label>ä½ç½® *</label>
              <input class="input" name="location" placeholder="ä¾‹å¦‚ï¼šä¸‡è±¡ / åŒåŸ" required />
            </div>

            <div>
              <label>æˆè‰²</label>
              <select class="select" name="condition">
                <option value="å…¨æ–°">å…¨æ–°</option>
                <option value="å‡ ä¹å…¨æ–°">å‡ ä¹å…¨æ–°</option>
                <option value="è½»å¾®ä½¿ç”¨" selected>è½»å¾®ä½¿ç”¨</option>
                <option value="æ˜æ˜¾ä½¿ç”¨">æ˜æ˜¾ä½¿ç”¨</option>
                <option value="éœ€è¦ç»´ä¿®">éœ€è¦ç»´ä¿®</option>
              </select>
            </div>

            <div>
              <label>äº¤æ˜“æ–¹å¼</label>
              <select class="select" name="transactionType">
                <option value="é¢äº¤" selected>é¢äº¤</option>
                <option value="é‚®å¯„">é‚®å¯„</option>
                <option value="å‡å¯">å‡å¯</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>è¯¦ç»†æè¿° *</label>
            <textarea class="textarea" name="description" maxlength="500" placeholder="å†™æ¸…æ¥šï¼šå‹å·/ä½¿ç”¨æƒ…å†µ/åŒ…å«é…ä»¶/ç‘•ç–µè¯´æ˜â€¦"
              required></textarea>
          </div>

          <div class="uploader" style="margin-top:10px;">
            <div>
              <label>ä¸Šä¼ å›¾ç‰‡ï¼ˆæœ€å¤š9å¼ ï¼‰</label>
              <input class="input" style="padding:10px;" type="file" id="images" name="images" accept="image/*"
                multiple />
              <div class="hint">ç¬¬ä¸€å¼ é»˜è®¤ä½œä¸ºå°é¢ã€‚å»ºè®®æ¸…æ™°ã€æ˜äº®ã€‚</div>
              <div class="preview" id="imgPreview"></div>
            </div>

            <div>
              <label>ä¸Šä¼ è§†é¢‘ï¼ˆå¯é€‰ï¼Œ10MBä»¥å†…ï¼‰</label>
              <input class="input" style="padding:10px;" type="file" id="video" name="video" accept="video/*" />
              <div class="hint" id="videoHint">å¯ä¸ä¼ ã€‚çŸ­è§†é¢‘èƒ½æ›´å¿«æˆäº¤ã€‚</div>
            </div>
          </div>

          <!-- åç«¯å­—æ®µï¼štelegramId / type -->
          <input type="hidden" name="telegramId" id="telegramId" />
          <input type="hidden" name="type" value="sell" />
        </div>

        <div class="actions">
          <button type="button" class="btn btn-ghost" id="resetBtn">æ¸…ç©º</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">å‘å¸ƒé—²ç½®</button>
        </div>
      </form>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API_BASE = "/second-hand-api";

    function toast(msg) {
      const t = document.getElementById("toast");
      t.textContent = String(msg || "");
      t.classList.add("show");
      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => t.classList.remove("show"), 1800);
      // Telegram ä¹Ÿå¼¹ä¸€ä¸‹ï¼ˆä¸ä¾èµ–ï¼‰
      try {
        if (window.Telegram?.WebApp?.showPopup) Telegram.WebApp.showPopup({ message: String(msg) });
      } catch { }
    }

    function getTgid() {
      const u = new URL(location.href);
      const qid = u.searchParams.get("tgid");
      if (qid) return qid;
      return window.Telegram?.WebApp?.initDataUnsafe?.user?.id || "";
    }

    async function api(path, opt) {
      const res = await fetch(API_BASE + path, {
        method: opt?.method || "GET",
        headers: opt?.headers,
        body: opt?.body
      });
      const j = await res.json().catch(() => null);
      if (!j || j.ok !== true) throw new Error(j?.msg || "è¯·æ±‚å¤±è´¥");
      return j.data;
    }

    // åˆå§‹åŒ– Telegram WebAppï¼ˆå¯é€‰ï¼‰
    (function initTelegram() {
      try {
        if (window.Telegram?.WebApp) {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
        }
      } catch { }
    })();

    // è¿”å›æŒ‰é’®
    document.getElementById("backBtn").addEventListener("click", () => {
      // ä¼˜å…ˆå›ä¸Šä¸€é¡µï¼Œå¦åˆ™å›é¦–é¡µ
      if (history.length > 1) history.back();
      else location.href = "/second-hand/index.html";
    });

    // å¡«å…… TGID
    const tgid = String(getTgid() || "");
    document.getElementById("telegramId").value = tgid;
    document.getElementById("tgInfo").textContent = tgid ? ("TGID: " + tgid) : "TGID: æœªè¯†åˆ«";

    // åŠ è½½åˆ†ç±»
    async function loadCategories() {
      const sel = document.getElementById("categorySel");
      sel.innerHTML = `<option value="">åŠ è½½ä¸­...</option>`;
      try {
        const cats = await api("/categories");
        sel.innerHTML = `<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>`;
        for (const c of cats) {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = `${c.icon || "ğŸ“¦"} ${c.name || c.id}`;
          sel.appendChild(opt);
        }
      } catch (e) {
        sel.innerHTML = `<option value="">åˆ†ç±»åŠ è½½å¤±è´¥</option>`;
        toast("åˆ†ç±»åŠ è½½å¤±è´¥ï¼š" + (e.message || ""));
      }
    }

    // å›¾ç‰‡é¢„è§ˆï¼ˆæœ€å¤š9å¼ ï¼‰
    const imgInput = document.getElementById("images");
    const imgPreview = document.getElementById("imgPreview");

    imgInput.addEventListener("change", () => {
      imgPreview.innerHTML = "";
      const files = Array.from(imgInput.files || []).slice(0, 9);
      if ((imgInput.files || []).length > 9) toast("æœ€å¤šåªèƒ½é€‰ 9 å¼ å›¾ç‰‡");
      for (const f of files) {
        const url = URL.createObjectURL(f);
        const box = document.createElement("div");
        box.className = "thumb";
        box.innerHTML = `<img src="${url}" alt="">`;
        imgPreview.appendChild(box);
      }
    });

    // è§†é¢‘æç¤º
    const videoInput = document.getElementById("video");
    const videoHint = document.getElementById("videoHint");
    videoInput.addEventListener("change", () => {
      const f = videoInput.files?.[0];
      if (!f) { videoHint.textContent = "å¯ä¸ä¼ ã€‚çŸ­è§†é¢‘èƒ½æ›´å¿«æˆäº¤ã€‚"; return; }
      const mb = (f.size / (1024 * 1024)).toFixed(2);
      videoHint.textContent = `å·²é€‰æ‹©ï¼š${f.name}ï¼ˆ${mb}MBï¼‰`;
    });

    // æ¸…ç©º
    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("sellForm").reset();
      document.getElementById("telegramId").value = tgid;
      imgPreview.innerHTML = "";
      videoHint.textContent = "å¯ä¸ä¼ ã€‚çŸ­è§†é¢‘èƒ½æ›´å¿«æˆäº¤ã€‚";
    });

    // æäº¤
    document.getElementById("sellForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      btn.style.filter = "grayscale(.2)";
      btn.textContent = "å‘å¸ƒä¸­...";

      try {
        // FormDataï¼ˆå­—æ®µåä¸åç«¯ä¸€è‡´ï¼‰
        const fd = new FormData(e.target);

        // é™åˆ¶ï¼šæœ€å¤š9å¼ å›¾ç‰‡ï¼ˆåç«¯ä¹Ÿæ˜¯ 9ï¼‰
        const imgs = Array.from(imgInput.files || []);
        if (imgs.length > 9) throw new Error("æœ€å¤šä¸Šä¼  9 å¼ å›¾ç‰‡");

        // åç«¯ï¼š/api/items éœ€è¦ title/price/category/location/description
        // è¿™é‡Œå‰ç«¯å†è¡¥ä¸€å±‚æ£€æŸ¥ï¼ˆé˜²ç©ºå­—ç¬¦ä¸²ï¼‰
        const must = ["title", "price", "category", "location", "description"];
        for (const k of must) {
          const v = String(fd.get(k) || "").trim();
          if (!v) throw new Error("è¯·å¡«å†™å¿…å¡«é¡¹ï¼š" + k);
          fd.set(k, v);
        }

        // è‹¥ TGID æœªè¯†åˆ«ï¼Œä¹Ÿå…è®¸å‘å¸ƒï¼ˆåç«¯ä¼šå†™ anonymous æˆ–ç©ºå­—ç¬¦ä¸²ï¼‰
        if (!fd.get("telegramId")) fd.set("telegramId", "");

        const created = await api("/items", { method: "POST", body: fd });
        toast("å‘å¸ƒæˆåŠŸ âœ…");

        // æˆåŠŸåè·³å›é¦–é¡µæˆ–ç›´æ¥æ‰“å¼€è¯¦æƒ…ï¼ˆä½ ç›®å‰è¯¦æƒ…æ˜¯ modalï¼Œåœ¨é¦–é¡µï¼‰
        setTimeout(() => {
          location.href = "/second-hand/index.html";
        }, 350);

      } catch (err) {
        toast(err.message || "å‘å¸ƒå¤±è´¥");
      } finally {
        btn.disabled = false;
        btn.style.filter = "";
        btn.textContent = "å‘å¸ƒé—²ç½®";
      }
    });

    loadCategories();
  </script>
</body>

</html>
